# .github/workflows/sync-labels.yml
name: åŒæ­¥ Labels åˆ°éŠæˆ²é–‹ç™¼å°ˆæ¡ˆ

on:
  # ç•¶ labels.yml è¢«ä¿®æ”¹æ™‚è‡ªå‹•åŸ·è¡Œ
  push:
    paths:
      - '.github/labels.yml'
    branches:
      - main

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'DaevaLab'
        required: false
        type: string
      dry_run:
        description: 'åƒ…é è¦½è®Šæ›´ï¼Œä¸å¯¦éš›åŸ·è¡Œ'
        required: false
        type: boolean
        default: false

jobs:
  sync-labels:
    runs-on: ubuntu-latest
    name: åŒæ­¥ Labels åˆ°éŠæˆ²é–‹ç™¼å°ˆæ¡ˆ

    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£ github-label-sync å·¥å…·
        run: npm install -g github-label-sync

      - name: æº–å‚™ç›®æ¨™å€‰åº«åˆ—è¡¨
        id: prepare-repos
        run: |
          # é è¨­çš„éŠæˆ²é–‹ç™¼å°ˆæ¡ˆå€‰åº«åˆ—è¡¨ï¼ˆè«‹ä¿®æ”¹ç‚ºä½ çš„å¯¦éš›å€‰åº«ï¼‰
          DEFAULT_REPOS=(
            "your-username/game-engine"
            "your-username/game-framework"
            "your-username/game-project-a"
            "your-username/game-project-b"
            "your-org/main-game"
            "your-org/game-tools"
          )
          
          if [ -n "${{ github.event.inputs.target_repos }}" ]; then
            # ä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„å€‰åº«åˆ—è¡¨
            IFS=',' read -ra REPOS <<< "${{ github.event.inputs.target_repos }}"
          else
            # ä½¿ç”¨é è¨­åˆ—è¡¨
            REPOS=("${DEFAULT_REPOS[@]}")
          fi
          
          # è¼¸å‡ºå€‰åº«åˆ—è¡¨ä¾›å¾ŒçºŒä½¿ç”¨
          printf '%s\n' "${REPOS[@]}" > repos.txt
          echo "ğŸ“‹ æº–å‚™åŒæ­¥åˆ°ä»¥ä¸‹å€‰åº«ï¼š"
          cat repos.txt | sed 's/^/  - /'

      - name: é©—è­‰ Labels è¨­å®šæª”
        run: |
          echo "ğŸ” é©—è­‰ labels.yml æ ¼å¼..."
          # æª¢æŸ¥ YAML æ ¼å¼æ˜¯å¦æ­£ç¢º
          python3 -c "
          import yaml
          import sys
          try:
              with open('.github/labels.yml', 'r', encoding='utf-8') as f:
                  labels = yaml.safe_load(f)
              print(f'âœ… ç™¼ç¾ {len(labels)} å€‹ labels è¨­å®š')
          
              # æª¢æŸ¥å¿…è¦æ¬„ä½
              for i, label in enumerate(labels):
                  if 'name' not in label:
                      print(f'âŒ Label {i+1} ç¼ºå°‘ name æ¬„ä½')
                      sys.exit(1)
                  if 'color' not in label:
                      print(f'âŒ Label {i+1} ({label[\"name\"]}) ç¼ºå°‘ color æ¬„ä½')
                      sys.exit(1)
          
              print('âœ… Labels è¨­å®šæª”æ ¼å¼æ­£ç¢º')
          except Exception as e:
              print(f'âŒ Labels è¨­å®šæª”æ ¼å¼éŒ¯èª¤: {e}')
              sys.exit(1)
          "

      - name: é è¦½è®Šæ›´ï¼ˆDry Runï¼‰
        if: github.event.inputs.dry_run == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” é è¦½æ¨¡å¼ï¼šé¡¯ç¤ºå°‡è¦é€²è¡Œçš„è®Šæ›´"
          echo "============================================="
          
          while IFS= read -r repo; do
            repo=$(echo $repo | xargs)
            echo ""
            echo "ğŸ“¦ å€‰åº«: $repo"
            echo "---"
          
            # ä½¿ç”¨ github-label-sync çš„ dry-run æ¨¡å¼
            github-label-sync --access-token "$GITHUB_TOKEN" --labels .github/labels.yml --dry-run $repo || true
          
          done < repos.txt
          
          echo ""
          echo "â„¹ï¸  é€™æ˜¯é è¦½æ¨¡å¼ï¼Œæœªé€²è¡Œå¯¦éš›è®Šæ›´"

      - name: åŸ·è¡Œ Labels åŒæ­¥
        if: github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ é–‹å§‹åŒæ­¥ labels..."
          FAILED_REPOS=()
          SUCCESS_COUNT=0
          
          while IFS= read -r repo; do
            repo=$(echo $repo | xargs)
            echo ""
            echo "ğŸ”„ æ­£åœ¨åŒæ­¥åˆ°: $repo"
            echo "---"
          
            # åŸ·è¡ŒåŒæ­¥
            if github-label-sync --access-token "$GITHUB_TOKEN" --labels .github/labels.yml $repo; then
              echo "âœ… æˆåŠŸåŒæ­¥åˆ° $repo"
              ((SUCCESS_COUNT++))
            else
              echo "âŒ åŒæ­¥å¤±æ•—: $repo"
              FAILED_REPOS+=("$repo")
            fi
          
            # æ·»åŠ å»¶é²é¿å… API é™åˆ¶
            sleep 2
          
          done < repos.txt
          
          echo ""
          echo "ğŸ“Š åŒæ­¥çµæœæ‘˜è¦ï¼š"
          echo "  æˆåŠŸ: $SUCCESS_COUNT å€‹å€‰åº«"
          echo "  å¤±æ•—: ${#FAILED_REPOS[@]} å€‹å€‰åº«"
          
          if [ ${#FAILED_REPOS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ å¤±æ•—çš„å€‰åº«ï¼š"
            printf '  - %s\n' "${FAILED_REPOS[@]}"
            exit 1
          fi

      - name: ç”¢ç”ŸåŒæ­¥å ±å‘Š
        if: always()
        run: |
          echo "# ğŸ® éŠæˆ²é–‹ç™¼å°ˆæ¡ˆ Labels åŒæ­¥å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŸ·è¡Œæ™‚é–“ï¼š** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¸ç™¼æ–¹å¼ï¼š** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**æ¨¡å¼ï¼š** ğŸ” é è¦½æ¨¡å¼ï¼ˆæœªå¯¦éš›è®Šæ›´ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æ¨¡å¼ï¼š** ğŸš€ å¯¦éš›åŒæ­¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ ç›®æ¨™å€‰åº«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r repo; do
            repo=$(echo $repo | xargs)
            echo "- [$repo](https://github.com/$repo/labels)" >> $GITHUB_STEP_SUMMARY
          done < repos.txt
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ·ï¸ Labels çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # çµ±è¨ˆå„é¡å‹ labels æ•¸é‡
          echo "- **ç¸½è¨ˆï¼š** $(grep -c '^- name:' .github/labels.yml) å€‹ labels" >> $GITHUB_STEP_SUMMARY
          echo "- **å€åŸŸåˆ†é¡ (area)ï¼š** $(grep -c '^- name: "area:' .github/labels.yml) å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **éŒ¯èª¤åˆ†é¡ (bug)ï¼š** $(grep -c '^- name: "bug:' .github/labels.yml) å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **åŠŸèƒ½åˆ†é¡ (feature)ï¼š** $(grep -c '^- name: "feature:' .github/labels.yml) å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **å„ªå…ˆç´š (priority)ï¼š** $(grep -c '^- name: "priority:' .github/labels.yml) å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‹€æ…‹ (status)ï¼š** $(grep -c '^- name: "status:' .github/labels.yml) å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **å…¶ä»–ï¼š** $(grep -E '^- name: "(build-system|documentation|platform|tools)"' .github/labels.yml | wc -l) å€‹" >> $GITHUB_STEP_SUMMARY